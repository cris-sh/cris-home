---
import BaseHead from "../../../components/BaseHead.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../../../consts";
import { getCollection } from "astro:content";
import FormattedDate from "../../../components/FormattedDate.astro";
import NavBar from "../../../components/navigation/NavBar.astro";
import { Image } from "astro:assets";
import { languages } from "../../../i18n/pages";
import { useTranslations } from "../../../i18n/utils";

export async function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({ params: { lang } }));
}

const { lang } = Astro.params;
const t = useTranslations(lang as keyof typeof languages);

const posts = (
  await getCollection("blog", (post) => {
    const matches =
      lang === "es"
        ? post.id.startsWith("es/") || post.data.lang === "es"
        : post.id.startsWith("en/") ||
          !post.data.lang ||
          post.data.lang === "en";
    return matches;
  })
).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const getSlug = (id: any) => {
  const parts = id.split("/");
  return parts.length > 1 ? parts[1] : id;
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
    <style>
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="bg-[#050505] text-white">
    <NavBar />
    <main class="max-w-5xl mx-auto px-6 pt-24 pb-20">
      <header class="mb-16 flex flex-col items-center text-center">
        <h1 class="text-4xl md:text-5xl font-bold tracking-tight mb-4">Blog</h1>
        <p class="text-lg text-white/60 max-w-2xl">
          {lang === 'es' ? 'Ideas sobre ingeniería de software, diseño y creación de productos.' : 'Thoughts on software engineering, design, and building products.'}
        </p>
      </header>
      {
        posts.length < 1 ? (
          <div class="text-center py-16 backdrop-blur-md bg-white/5 border border-white/10 rounded-2xl">
            <h2 class="text-xl mb-2 font-semibold">
                {lang === 'es' ? 'no se encontraron publicaciones' : 'no blog posts found'}
            </h2>
            <p class="text-white/60">
                {lang === 'es' ? 'vuelve pronto por nuevo contenido' : 'check back soon for new content'}
            </p>
          </div>
        ) : (
          <div class="space-y-12">
            {/* Featured Post */}
            {posts.length > 0 && (
              <div class="group relative bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:bg-white/10 hover:border-white/20 transition-all duration-500">
                <a
                  href={`/${lang}/blog/${getSlug(posts[0].id)}/`}
                  class="flex flex-col md:flex-row h-full"
                >
                  <div class="md:w-3/5 overflow-hidden">
                    {
                      posts[0].data.heroImage && (
                        <Image
                          src={posts[0].data.heroImage}
                          alt=""
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 ease-out"
                          height={1080}
                          width={1920}
                          transition:name={`img-${getSlug(posts[0].id)}`}
                          draggable="false"
                        />
                      )
                    }
                  </div>
                  <div class="p-8 md:w-2/5 flex flex-col justify-between">
                    <div>
                      <div class="flex items-center gap-2 mb-4">
                        <span class="px-2 py-1 text-[10px] uppercase tracking-widest font-bold bg-white/10 rounded border border-white/10">
                            {lang === 'es' ? 'Destacado' : 'Featured'}
                        </span>
                        <div class="text-sm text-white/50">
                          <FormattedDate date={posts[0].data.date} lang={lang} />
                        </div>
                      </div>
                      <h3 class="text-3xl md:text-4xl font-bold tracking-tight mb-4 group-hover:text-white transition-colors">
                        {posts[0].data.title}
                      </h3>
                      <p class="text-white/60 mb-6 line-clamp-4 text-base leading-relaxed">
                        {posts[0].data.description}
                      </p>
                    </div>
                    <div class="flex items-center text-sm font-semibold text-white/80 group-hover:text-white transition-colors">
                      {lang === 'es' ? 'Leer publicación' : 'Read post'}
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                    </div>
                  </div>
                </a>
              </div>
            )}

            {/* Grid for the rest of posts */}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              {posts.slice(1).map((post) => (
                <div class="group bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden hover:bg-white/10 hover:border-white/20 transition-all duration-500">
                  <a href={`/${lang}/blog/${getSlug(post.id)}/`} class="flex flex-col h-full">
                    {
                      post.data.heroImage && (
                        <div class="overflow-hidden h-60">
                          <Image
                            src={post.data.heroImage}
                            alt=""
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700 ease-out"
                            height={720}
                            width={1280}
                            transition:name={`img-${getSlug(post.id)}`}
                            draggable="false"
                          />
                        </div>
                      )
                    }
                    <div class="p-6 flex flex-col flex-1">
                      <div class="text-xs text-white/50 mb-3 font-medium">
                        <FormattedDate date={post.data.date} lang={lang} />
                      </div>
                      <h3 class="text-xl font-bold tracking-tight mb-3 group-hover:text-white transition-colors">
                        {post.data.title}
                      </h3>
                      <p class="text-white/60 mb-6 line-clamp-2 text-sm leading-relaxed flex-1">
                        {post.data.description}
                      </p>
                      <div class="flex items-center text-sm font-semibold text-white/80 group-hover:text-white transition-colors">
                        {lang === 'es' ? 'Leer publicación' : 'Read post'}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                        </svg>
                      </div>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </div>
        )
      }
    </main>
  </body>
</html>
